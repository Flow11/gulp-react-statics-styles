"use strict";

require("6to5/polyfill");
var Promise = require("bluebird");
var through = require("through2");
var gutil = require("gulp-util");
var _ref = require("react-nexus-style");

var extractStyles = _ref.extractStyles;
var PluginError = gutil.PluginError;
var File = gutil.File;


var PLUGIN_NAME = "gulp-react-nexus-style";

module.exports = function (cachebust) {
  var _this = this;
  if (cachebust === undefined) cachebust = [];
  cachebust.forEach(function (module) {
    var r = require.resolve(module);
    if (require.cache[r]) {
      delete require.cache[r];
    }
  });

  return through.obj(function (file, enc, fn) {
    if (file.isNull()) {
      return fn(null, file);
    }
    if (file.isStream()) {
      return fn(new PluginError(PLUGIN_NAME, "Streaming not supported"));
    }
    var path = file.path;
    try {
      var r = require.resolve(path);
      if (require.cache[r]) {
        delete require.cache[r];
      }
      _this.push(new File({
        path: gutil.replaceExtension(path, "css"),
        contents: new Buffer(extractStyles(require(path))) }));
    } catch (err) {
      return fn(err);
    }
    return fn(null);
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImc6L3JlYWN0LW5leHVzL2d1bHAtcmVhY3QtbmV4dXMtc3R5bGUvc3JjL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pCLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNsQyxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDcEMsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1dBQ1QsT0FBTyxDQUFDLG1CQUFtQixDQUFDOztJQUE5QyxhQUFhLFFBQWIsYUFBYTtJQUNiLFdBQVcsR0FBVyxLQUFLLENBQTNCLFdBQVc7SUFBRSxJQUFJLEdBQUssS0FBSyxDQUFkLElBQUk7OztBQUV6QixJQUFNLFdBQVcsR0FBRyx3QkFBd0IsQ0FBQzs7QUFFN0MsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFTLFNBQVMsRUFBTzs7TUFBaEIsU0FBUyxnQkFBVCxTQUFTLEdBQUcsRUFBRTtBQUN0QyxXQUFTLENBQUMsT0FBTyxDQUFDLFVBQUMsTUFBTSxFQUFLO0FBQzVCLFFBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDaEMsUUFBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO0FBQ25CLGFBQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUN6QjtHQUNGLENBQUMsQ0FBQzs7QUFFSCxTQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBSztBQUNwQyxRQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsRUFBRTtBQUNoQixhQUFPLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDdkI7QUFDRCxRQUFHLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRTtBQUNsQixhQUFPLEVBQUUsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxXQUFXLEVBQUUseUJBQXlCLENBQUMsQ0FBQyxDQUFDO0tBQ3BFO1FBQ0ssSUFBSSxHQUFLLElBQUksQ0FBYixJQUFJO0FBQ1YsUUFBSTtBQUNGLFVBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDOUIsVUFBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO0FBQ25CLGVBQU8sT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztPQUN6QjtBQUNELFlBQUssSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO0FBQ2pCLFlBQUksRUFBRSxLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQztBQUN6QyxnQkFBUSxFQUFFLElBQUksTUFBTSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUNuRCxDQUFDLENBQUMsQ0FBQztLQUNMLENBQ0QsT0FBTSxHQUFHLEVBQUU7QUFDVCxhQUFPLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUNoQjtBQUNELFdBQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO0dBQ2pCLENBQUMsQ0FBQztDQUNKLENBQUMiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJyZXF1aXJlKCc2dG81L3BvbHlmaWxsJyk7XG52YXIgUHJvbWlzZSA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5jb25zdCB0aHJvdWdoID0gcmVxdWlyZSgndGhyb3VnaDInKTtcbmNvbnN0IGd1dGlsID0gcmVxdWlyZSgnZ3VscC11dGlsJyk7XG5jb25zdCB7IGV4dHJhY3RTdHlsZXMgfSA9IHJlcXVpcmUoJ3JlYWN0LW5leHVzLXN0eWxlJyk7XG5jb25zdCB7IFBsdWdpbkVycm9yLCBGaWxlIH0gPSBndXRpbDtcblxuY29uc3QgUExVR0lOX05BTUUgPSAnZ3VscC1yZWFjdC1uZXh1cy1zdHlsZSc7XG5cbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oY2FjaGVidXN0ID0gW10pIHtcbiAgY2FjaGVidXN0LmZvckVhY2goKG1vZHVsZSkgPT4ge1xuICAgIGxldCByID0gcmVxdWlyZS5yZXNvbHZlKG1vZHVsZSk7XG4gICAgaWYocmVxdWlyZS5jYWNoZVtyXSkge1xuICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcl07XG4gICAgfVxuICB9KTtcblxuICByZXR1cm4gdGhyb3VnaC5vYmooKGZpbGUsIGVuYywgZm4pID0+IHtcbiAgICBpZihmaWxlLmlzTnVsbCgpKSB7XG4gICAgICByZXR1cm4gZm4obnVsbCwgZmlsZSk7XG4gICAgfVxuICAgIGlmKGZpbGUuaXNTdHJlYW0oKSkge1xuICAgICAgcmV0dXJuIGZuKG5ldyBQbHVnaW5FcnJvcihQTFVHSU5fTkFNRSwgJ1N0cmVhbWluZyBub3Qgc3VwcG9ydGVkJykpO1xuICAgIH1cbiAgICBsZXQgeyBwYXRoIH0gPSBmaWxlO1xuICAgIHRyeSB7XG4gICAgICBsZXQgciA9IHJlcXVpcmUucmVzb2x2ZShwYXRoKTtcbiAgICAgIGlmKHJlcXVpcmUuY2FjaGVbcl0pIHtcbiAgICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcl07XG4gICAgICB9XG4gICAgICB0aGlzLnB1c2gobmV3IEZpbGUoe1xuICAgICAgICBwYXRoOiBndXRpbC5yZXBsYWNlRXh0ZW5zaW9uKHBhdGgsICdjc3MnKSxcbiAgICAgICAgY29udGVudHM6IG5ldyBCdWZmZXIoZXh0cmFjdFN0eWxlcyhyZXF1aXJlKHBhdGgpKSksXG4gICAgICB9KSk7XG4gICAgfVxuICAgIGNhdGNoKGVycikge1xuICAgICAgcmV0dXJuIGZuKGVycik7XG4gICAgfVxuICAgIHJldHVybiBmbihudWxsKTtcbiAgfSk7XG59O1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9