"use strict";

require("6to5/polyfill");
var Promise = require("bluebird");
var through = require("through2");
var gutil = require("gulp-util");
var _ref = require("react-nexus-style");

var extractStyles = _ref.extractStyles;
var PluginError = gutil.PluginError;
var File = gutil.File;


var PLUGIN_NAME = "gulp-react-nexus-style";

module.exports = function (cachebust) {
  var _this = this;
  if (cachebust === undefined) cachebust = [];
  var styles = [];
  var queue = [];
  cachebust.forEach(function (module) {
    var r = require.resolve(module);
    if (require.cache[r]) {
      delete require.cache[r];
    }
  });

  return through.obj(function (file, enc, fn) {
    if (file.isNull()) {
      return fn(null, file);
    }
    if (file.isStream()) {
      return fn(new PluginError(PLUGIN_NAME, "Streaming not supported"));
    }
    var path = file.path;
    try {
      var r = require.resolve(path);
      if (require.cache[r]) {
        delete require.cache[r];
      }
      _this.push(new File({
        path: gutil.replaceExtension(path, "css"),
        contents: new Buffer(extractStyles(require(path))) }));
    } catch (err) {
      return fn(err);
    }
    return fn(null);
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImc6L3JlYWN0LW5leHVzL2d1bHAtcmVhY3QtbmV4dXMtc3R5bGUvc3JjL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pCLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNsQyxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDcEMsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1dBQ1QsT0FBTyxDQUFDLG1CQUFtQixDQUFDOztJQUE5QyxhQUFhLFFBQWIsYUFBYTtJQUNiLFdBQVcsR0FBVyxLQUFLLENBQTNCLFdBQVc7SUFBRSxJQUFJLEdBQUssS0FBSyxDQUFkLElBQUk7OztBQUV6QixJQUFNLFdBQVcsR0FBRyx3QkFBd0IsQ0FBQzs7QUFFN0MsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFTLFNBQVMsRUFBTzs7TUFBaEIsU0FBUyxnQkFBVCxTQUFTLEdBQUcsRUFBRTtBQUN0QyxNQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7QUFDaEIsTUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO0FBQ2YsV0FBUyxDQUFDLE9BQU8sQ0FBQyxVQUFDLE1BQU0sRUFBSztBQUM1QixRQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ2hDLFFBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtBQUNuQixhQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDekI7R0FDRixDQUFDLENBQUM7O0FBRUgsU0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUs7QUFDcEMsUUFBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUU7QUFDaEIsYUFBTyxFQUFFLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ3ZCO0FBQ0QsUUFBRyxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUU7QUFDbEIsYUFBTyxFQUFFLENBQUMsSUFBSSxXQUFXLENBQUMsV0FBVyxFQUFFLHlCQUF5QixDQUFDLENBQUMsQ0FBQztLQUNwRTtRQUNLLElBQUksR0FBSyxJQUFJLENBQWIsSUFBSTtBQUNWLFFBQUk7QUFDRixVQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQzlCLFVBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtBQUNuQixlQUFPLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7T0FDekI7QUFDRCxZQUFLLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztBQUNqQixZQUFJLEVBQUUsS0FBSyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxLQUFLLENBQUM7QUFDekMsZ0JBQVEsRUFBRSxJQUFJLE1BQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFDbkQsQ0FBQyxDQUFDLENBQUM7S0FDTCxDQUNELE9BQU0sR0FBRyxFQUFFO0FBQ1QsYUFBTyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDaEI7QUFDRCxXQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztHQUNqQixDQUFDLENBQUM7Q0FDSixDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsicmVxdWlyZSgnNnRvNS9wb2x5ZmlsbCcpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuY29uc3QgdGhyb3VnaCA9IHJlcXVpcmUoJ3Rocm91Z2gyJyk7XG5jb25zdCBndXRpbCA9IHJlcXVpcmUoJ2d1bHAtdXRpbCcpO1xuY29uc3QgeyBleHRyYWN0U3R5bGVzIH0gPSByZXF1aXJlKCdyZWFjdC1uZXh1cy1zdHlsZScpO1xuY29uc3QgeyBQbHVnaW5FcnJvciwgRmlsZSB9ID0gZ3V0aWw7XG5cbmNvbnN0IFBMVUdJTl9OQU1FID0gJ2d1bHAtcmVhY3QtbmV4dXMtc3R5bGUnO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNhY2hlYnVzdCA9IFtdKSB7XG4gIGxldCBzdHlsZXMgPSBbXTtcbiAgbGV0IHF1ZXVlID0gW107XG4gIGNhY2hlYnVzdC5mb3JFYWNoKChtb2R1bGUpID0+IHtcbiAgICBsZXQgciA9IHJlcXVpcmUucmVzb2x2ZShtb2R1bGUpO1xuICAgIGlmKHJlcXVpcmUuY2FjaGVbcl0pIHtcbiAgICAgIGRlbGV0ZSByZXF1aXJlLmNhY2hlW3JdO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHRocm91Z2gub2JqKChmaWxlLCBlbmMsIGZuKSA9PiB7XG4gICAgaWYoZmlsZS5pc051bGwoKSkge1xuICAgICAgcmV0dXJuIGZuKG51bGwsIGZpbGUpO1xuICAgIH1cbiAgICBpZihmaWxlLmlzU3RyZWFtKCkpIHtcbiAgICAgIHJldHVybiBmbihuZXcgUGx1Z2luRXJyb3IoUExVR0lOX05BTUUsICdTdHJlYW1pbmcgbm90IHN1cHBvcnRlZCcpKTtcbiAgICB9XG4gICAgbGV0IHsgcGF0aCB9ID0gZmlsZTtcbiAgICB0cnkge1xuICAgICAgbGV0IHIgPSByZXF1aXJlLnJlc29sdmUocGF0aCk7XG4gICAgICBpZihyZXF1aXJlLmNhY2hlW3JdKSB7XG4gICAgICAgIGRlbGV0ZSByZXF1aXJlLmNhY2hlW3JdO1xuICAgICAgfVxuICAgICAgdGhpcy5wdXNoKG5ldyBGaWxlKHtcbiAgICAgICAgcGF0aDogZ3V0aWwucmVwbGFjZUV4dGVuc2lvbihwYXRoLCAnY3NzJyksXG4gICAgICAgIGNvbnRlbnRzOiBuZXcgQnVmZmVyKGV4dHJhY3RTdHlsZXMocmVxdWlyZShwYXRoKSkpLFxuICAgICAgfSkpO1xuICAgIH1cbiAgICBjYXRjaChlcnIpIHtcbiAgICAgIHJldHVybiBmbihlcnIpO1xuICAgIH1cbiAgICByZXR1cm4gZm4obnVsbCk7XG4gIH0pO1xufVxuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9