"use strict";

require("6to5/polyfill");
var Promise = require("bluebird");
var through = require("through2");
var gutil = require("gulp-util");
var _ref = require("react-nexus-style");

var extractStyles = _ref.extractStyles;
var PluginError = gutil.PluginError;
var File = gutil.File;


var PLUGIN_NAME = "gulp-react-nexus-style";

module.exports = function (cachebust) {
  if (cachebust === undefined) cachebust = [];
  cachebust.forEach(function (module) {
    var r = require.resolve(module);
    if (require.cache[r]) {
      delete require.cache[r];
    }
  });

  return through.obj(function (file, enc, fn) {
    if (file.isNull()) {
      return fn(null, file);
    }
    if (file.isStream()) {
      return fn(new PluginError(PLUGIN_NAME, "Streaming not supported"));
    }
    var path = file.path;
    try {
      var r = require.resolve(path);
      if (require.cache[r]) {
        delete require.cache[r];
      }
      this.push(new File({
        path: gutil.replaceExtension(path, "css"),
        contents: new Buffer(extractStyles(require(path))) }));
    } catch (err) {
      return fn(err);
    }
    return fn(null);
  });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImc6L3JlYWN0LW5leHVzL2d1bHAtcmVhY3QtbmV4dXMtc3R5bGUvc3JjL2luZGV4LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pCLElBQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNsQyxJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDcEMsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1dBQ1QsT0FBTyxDQUFDLG1CQUFtQixDQUFDOztJQUE5QyxhQUFhLFFBQWIsYUFBYTtJQUNiLFdBQVcsR0FBVyxLQUFLLENBQTNCLFdBQVc7SUFBRSxJQUFJLEdBQUssS0FBSyxDQUFkLElBQUk7OztBQUV6QixJQUFNLFdBQVcsR0FBRyx3QkFBd0IsQ0FBQzs7QUFFN0MsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFTLFNBQVMsRUFBTztNQUFoQixTQUFTLGdCQUFULFNBQVMsR0FBRyxFQUFFO0FBQ3RDLFdBQVMsQ0FBQyxPQUFPLENBQUMsVUFBQyxNQUFNLEVBQUs7QUFDNUIsUUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNoQyxRQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7QUFDbkIsYUFBTyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3pCO0dBQ0YsQ0FBQyxDQUFDOztBQUVILFNBQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFTLElBQUksRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFO0FBQ3pDLFFBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFO0FBQ2hCLGFBQU8sRUFBRSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztLQUN2QjtBQUNELFFBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFO0FBQ2xCLGFBQU8sRUFBRSxDQUFDLElBQUksV0FBVyxDQUFDLFdBQVcsRUFBRSx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7S0FDcEU7UUFDSyxJQUFJLEdBQUssSUFBSSxDQUFiLElBQUk7QUFDVixRQUFJO0FBQ0YsVUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM5QixVQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7QUFDbkIsZUFBTyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO09BQ3pCO0FBQ0QsVUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQztBQUNqQixZQUFJLEVBQUUsS0FBSyxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRSxLQUFLLENBQUM7QUFDekMsZ0JBQVEsRUFBRSxJQUFJLE1BQU0sQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFDbkQsQ0FBQyxDQUFDLENBQUM7S0FDTCxDQUNELE9BQU0sR0FBRyxFQUFFO0FBQ1QsYUFBTyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDaEI7QUFDRCxXQUFPLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQztHQUNqQixDQUFDLENBQUM7Q0FDSixDQUFDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsicmVxdWlyZSgnNnRvNS9wb2x5ZmlsbCcpO1xudmFyIFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xuY29uc3QgdGhyb3VnaCA9IHJlcXVpcmUoJ3Rocm91Z2gyJyk7XG5jb25zdCBndXRpbCA9IHJlcXVpcmUoJ2d1bHAtdXRpbCcpO1xuY29uc3QgeyBleHRyYWN0U3R5bGVzIH0gPSByZXF1aXJlKCdyZWFjdC1uZXh1cy1zdHlsZScpO1xuY29uc3QgeyBQbHVnaW5FcnJvciwgRmlsZSB9ID0gZ3V0aWw7XG5cbmNvbnN0IFBMVUdJTl9OQU1FID0gJ2d1bHAtcmVhY3QtbmV4dXMtc3R5bGUnO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGNhY2hlYnVzdCA9IFtdKSB7XG4gIGNhY2hlYnVzdC5mb3JFYWNoKChtb2R1bGUpID0+IHtcbiAgICBsZXQgciA9IHJlcXVpcmUucmVzb2x2ZShtb2R1bGUpO1xuICAgIGlmKHJlcXVpcmUuY2FjaGVbcl0pIHtcbiAgICAgIGRlbGV0ZSByZXF1aXJlLmNhY2hlW3JdO1xuICAgIH1cbiAgfSk7XG5cbiAgcmV0dXJuIHRocm91Z2gub2JqKGZ1bmN0aW9uKGZpbGUsIGVuYywgZm4pIHtcbiAgICBpZihmaWxlLmlzTnVsbCgpKSB7XG4gICAgICByZXR1cm4gZm4obnVsbCwgZmlsZSk7XG4gICAgfVxuICAgIGlmKGZpbGUuaXNTdHJlYW0oKSkge1xuICAgICAgcmV0dXJuIGZuKG5ldyBQbHVnaW5FcnJvcihQTFVHSU5fTkFNRSwgJ1N0cmVhbWluZyBub3Qgc3VwcG9ydGVkJykpO1xuICAgIH1cbiAgICBsZXQgeyBwYXRoIH0gPSBmaWxlO1xuICAgIHRyeSB7XG4gICAgICBsZXQgciA9IHJlcXVpcmUucmVzb2x2ZShwYXRoKTtcbiAgICAgIGlmKHJlcXVpcmUuY2FjaGVbcl0pIHtcbiAgICAgICAgZGVsZXRlIHJlcXVpcmUuY2FjaGVbcl07XG4gICAgICB9XG4gICAgICB0aGlzLnB1c2gobmV3IEZpbGUoe1xuICAgICAgICBwYXRoOiBndXRpbC5yZXBsYWNlRXh0ZW5zaW9uKHBhdGgsICdjc3MnKSxcbiAgICAgICAgY29udGVudHM6IG5ldyBCdWZmZXIoZXh0cmFjdFN0eWxlcyhyZXF1aXJlKHBhdGgpKSksXG4gICAgICB9KSk7XG4gICAgfVxuICAgIGNhdGNoKGVycikge1xuICAgICAgcmV0dXJuIGZuKGVycik7XG4gICAgfVxuICAgIHJldHVybiBmbihudWxsKTtcbiAgfSk7XG59O1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9